<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Privilege separation - Tere Documentation</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="../../doc/custom.css">
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../../architecture/index.html"><strong aria-hidden="true">2.</strong> Architecture</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../architecture/dbus.html"><strong aria-hidden="true">2.1.</strong> D-Bus</a></li></ol></li><li class="chapter-item expanded "><a href="../../roadmap.html"><strong aria-hidden="true">3.</strong> Roadmap</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Comparisons</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../compare/openssh.html"><strong aria-hidden="true">4.1.</strong> OpenSSH</a></li><li class="chapter-item "><a href="../../compare/mosh.html"><strong aria-hidden="true">4.2.</strong> Mosh</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> For developers</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../dev/decisions.html"><strong aria-hidden="true">5.1.</strong> Decisions</a></li><li class="chapter-item "><div><strong aria-hidden="true">5.2.</strong> Background</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../dev/background/dbus.html"><strong aria-hidden="true">5.2.1.</strong> D-Bus</a></li><li class="chapter-item "><a href="../../dev/background/websockets.html"><strong aria-hidden="true">5.2.2.</strong> WebSockets</a></li><li class="chapter-item "><a href="../../dev/background/pty-stdin-stdout.html"><strong aria-hidden="true">5.2.3.</strong> PTY to stdin/stdout plumbing</a></li></ol></li><li class="chapter-item expanded "><a href="../../dev/sketch/index.html"><strong aria-hidden="true">5.3.</strong> Sketches</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../dev/sketch/privsep.html" class="active"><strong aria-hidden="true">5.3.1.</strong> Privilege separation</a></li><li class="chapter-item "><a href="../../dev/sketch/protocols.html"><strong aria-hidden="true">5.3.2.</strong> Protocols used in IPC</a></li><li class="chapter-item "><a href="../../dev/sketch/ipc.html"><strong aria-hidden="true">5.3.3.</strong> IPC</a></li><li class="chapter-item "><a href="../../dev/sketch/attacks.html"><strong aria-hidden="true">5.3.4.</strong> Attacks</a></li><li class="chapter-item "><a href="../../dev/sketch/bastion.html"><strong aria-hidden="true">5.3.5.</strong> Bastion hosts considered harmful</a></li><li class="chapter-item "><a href="../../dev/sketch/unattended-authentication.html"><strong aria-hidden="true">5.3.6.</strong> Unattended authentication</a></li><li class="chapter-item "><a href="../../dev/sketch/account-store.html"><strong aria-hidden="true">5.3.7.</strong> Account store</a></li></ol></li><li class="chapter-item "><a href="../../dev/TODO.html"><strong aria-hidden="true">5.4.</strong> Tasks</a></li><li class="chapter-item "><a href="../../dev/resources.html"><strong aria-hidden="true">5.5.</strong> Resources</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Tere Documentation</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="privilege-separation"><a class="header" href="#privilege-separation">Privilege separation</a></h1>
<p>The Tere server consists of multiple co-operating, mostly mutually distrusting, processes.
(Threads are cheaper and can self-sandbox too, but that boundary doesn't prevent reading secrets.)</p>
<p>OpenSSH just privseps from <code>root</code> into the destination user account.
We, however, might be launching sessions in containers, and not on the host itself, we don't switch <code>uid</code> ourself, and the user might not even exist on the host.
We don't even run as <code>root</code> to be able to switch users!
We need to do things differently.</p>
<h2 id="services-and-processes"><a class="header" href="#services-and-processes">Services and processes</a></h2>
<p>The services communicate with each other via UNIX domain sockets.
Only <code>tere-server</code> serves TCP sockets, for HTTPS and HTTP.
All listening sockets are created via systemd socket activation (see <a href="https://www.freedesktop.org/software/systemd/man/systemd.socket.html">systemd.socket</a>).</p>
<p>All of the services use systemd configuration <a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#DynamicUser="><code>DynamicUser=yes</code></a> to run as a unique system account.
Extra group memberships (via <a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#SupplementaryGroups="><code>SupplementaryGroups=</code></a>) are used for access control between services, for UNIX domain sockets (groups <code>tere-socket-*</code>, named after the service connecting  <em>to</em>) and D-Bus (group <code>tere-dbus</code>).</p>
<p>Services named with a <code>@</code> suffix (after the <a href="https://www.freedesktop.org/software/systemd/man/systemd.unit.html#Description">systemd convention</a>) run as multiple instances.
They use systemd <a href="https://www.freedesktop.org/software/systemd/man/systemd.socket.html#Accept="><code>Accept=yes</code></a> to make systemd start a new instance for every incoming connection.
Additionally,  <a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#DynamicUser="><code>DynamicUser=yes</code></a> will isolate each connection from each other(<a href="http://0pointer.net/blog/dynamic-users-with-systemd.html">1</a>).</p>
<div><!-- Generated by graphviz version 2.43.0 (0)
 --><!-- Title: %3 Pages: 1 --><svg width="388pt" height="476pt"
 viewBox="0.00 0.00 388.30 476.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 472)"><title>%3</title><polygon fill="white" stroke="transparent" points="-4,4 -4,-472 384.3,-472 384.3,4 -4,4"/><!-- network --><g id="node1" class="node"><title>network</title><text text-anchor="middle" x="69.3" y="-446.3" font-family="Times-Roman" font-size="14.00">network</text></g><!-- server --><g id="node2" class="node"><title>server</title><ellipse fill="none" stroke="black" cx="69.3" cy="-378" rx="39.79" ry="18"/><text text-anchor="middle" x="69.3" y="-374.3" font-family="Times-Roman" font-size="14.00">server</text></g><!-- network&#45;&gt;server --><g id="edge1" class="edge"><title>network&#45;&gt;server</title><path fill="none" stroke="black" d="M69.3,-431.7C69.3,-423.98 69.3,-414.71 69.3,-406.11"/><polygon fill="black" stroke="black" points="69.3,-406.1 73.8,-396.1 69.3,-401.1 69.3,-396.1 69.3,-396.1 69.3,-396.1 69.3,-401.1 64.8,-396.1 69.3,-406.1 69.3,-406.1"/></g><!-- auth --><g id="node3" class="node"><title>auth</title><ellipse fill="none" stroke="black" cx="99.3" cy="-306" rx="31.4" ry="18"/><text text-anchor="middle" x="99.3" y="-302.3" font-family="Times-Roman" font-size="14.00">auth</text></g><!-- server&#45;&gt;auth --><g id="edge2" class="edge"><title>server&#45;&gt;auth</title><path fill="none" stroke="black" d="M76.56,-360.05C80.02,-351.97 84.24,-342.12 88.11,-333.11"/><polygon fill="black" stroke="black" points="91.38,-334.36 92.1,-323.79 84.94,-331.6 91.38,-334.36"/></g><!-- user --><g id="node4" class="node"><title>user</title><ellipse fill="none" stroke="black" cx="40.3" cy="-234" rx="40.09" ry="18"/><text text-anchor="middle" x="40.3" y="-230.3" font-family="Times-Roman" font-size="14.00">user@</text></g><!-- server&#45;&gt;user --><g id="edge5" class="edge"><title>server&#45;&gt;user</title><path fill="none" stroke="black" stroke-dasharray="5,2" d="M65.8,-359.87C60.22,-332.58 49.39,-279.52 43.81,-252.19"/></g><!-- auth&#45;&gt;user --><g id="edge4" class="edge"><title>auth&#45;&gt;user</title><path fill="none" stroke="black" d="M86.2,-289.46C78.59,-280.44 68.85,-268.88 60.3,-258.73"/><polygon fill="black" stroke="black" points="60.21,-258.62 57.2,-248.08 56.99,-254.8 53.76,-250.98 53.76,-250.98 53.76,-250.98 56.99,-254.8 50.32,-253.88 60.21,-258.62 60.21,-258.62"/></g><!-- policy --><g id="node5" class="node"><title>policy</title><ellipse fill="none" stroke="black" cx="108.3" cy="-162" rx="46.29" ry="18"/><text text-anchor="middle" x="108.3" y="-158.3" font-family="Times-Roman" font-size="14.00">policy@</text></g><!-- auth&#45;&gt;policy --><g id="edge3" class="edge"><title>auth&#45;&gt;policy</title><path fill="none" stroke="black" d="M100.38,-287.87C101.92,-263.67 104.73,-219.21 106.56,-190.39"/><polygon fill="black" stroke="black" points="106.57,-190.17 111.7,-180.47 106.89,-185.18 107.21,-180.19 107.21,-180.19 107.21,-180.19 106.89,-185.18 102.72,-179.9 106.57,-190.17 106.57,-190.17"/></g><!-- user&#45;&gt;policy --><g id="edge6" class="edge"><title>user&#45;&gt;policy</title><path fill="none" stroke="black" stroke-dasharray="5,2" d="M55.73,-217.12C66.7,-205.82 81.39,-190.7 92.46,-179.31"/></g><!-- pty --><g id="node9" class="node"><title>pty</title><ellipse fill="none" stroke="black" cx="110.3" cy="-18" rx="34.39" ry="18"/><text text-anchor="middle" x="110.3" y="-14.3" font-family="Times-Roman" font-size="14.00">pty@</text></g><!-- user&#45;&gt;pty --><g id="edge11" class="edge"><title>user&#45;&gt;pty</title><path fill="none" stroke="black" stroke-dasharray="5,2" d="M37.64,-215.96C33.68,-185.38 29.02,-119.9 52.3,-72 60.35,-55.44 76.04,-41.6 89.07,-32.23"/></g><!-- sessions --><g id="node6" class="node"><title>sessions</title><ellipse fill="none" stroke="black" cx="110.3" cy="-90" rx="49.29" ry="18"/><text text-anchor="middle" x="110.3" y="-86.3" font-family="Times-Roman" font-size="14.00">sessions</text></g><!-- policy&#45;&gt;sessions --><g id="edge7" class="edge"><title>policy&#45;&gt;sessions</title><path fill="none" stroke="black" d="M108.79,-143.7C109.01,-135.98 109.28,-126.71 109.52,-118.11"/><polygon fill="black" stroke="black" points="113.02,-118.2 109.81,-108.1 106.02,-118 113.02,-118.2"/></g><!-- dbus --><g id="node7" class="node"><title>dbus</title><polygon fill="none" stroke="blue" points="380.3,-36 326.3,-36 326.3,0 380.3,0 380.3,-36"/><text text-anchor="middle" x="353.3" y="-14.3" font-family="Times-Roman" font-size="14.00">dbus</text></g><!-- sessions&#45;&gt;dbus --><g id="edge8" class="edge"><title>sessions&#45;&gt;dbus</title><path fill="none" stroke="blue" d="M152.63,-80.64C192.91,-72.14 255.18,-57.57 316.56,-35.93"/><polygon fill="blue" stroke="blue" points="317.78,-39.22 326.01,-32.54 315.41,-32.63 317.78,-39.22"/></g><!-- systemd --><g id="node8" class="node"><title>systemd</title><polygon fill="none" stroke="blue" points="308.3,-36 162.3,-36 162.3,0 308.3,0 308.3,-36"/><text text-anchor="middle" x="235.3" y="-14.3" font-family="Times-Roman" font-size="14.00">systemd FDSTORE</text></g><!-- sessions&#45;&gt;systemd --><g id="edge9" class="edge"><title>sessions&#45;&gt;systemd</title><path fill="none" stroke="blue" d="M136.2,-74.5C153.36,-64.89 176.21,-52.09 195.64,-41.21"/><polygon fill="blue" stroke="blue" points="197.56,-44.14 204.58,-36.2 194.14,-38.04 197.56,-44.14"/></g><!-- sessions&#45;&gt;pty --><g id="edge10" class="edge"><title>sessions&#45;&gt;pty</title><path fill="none" stroke="black" d="M110.3,-71.7C110.3,-63.98 110.3,-54.71 110.3,-46.11"/><polygon fill="black" stroke="black" points="110.3,-46.1 114.8,-36.1 110.3,-41.1 110.3,-36.1 110.3,-36.1 110.3,-36.1 110.3,-41.1 105.8,-36.1 110.3,-46.1 110.3,-46.1"/></g></g></svg></div>
<h3 id="tere-server-is-the-entry-point-from-the-network"><a class="header" href="#tere-server-is-the-entry-point-from-the-network"><code>tere-server</code> is the entry point from the network</a></h3>
<p><code>tere-server</code> serves things like static HTTP assets.
It holds an extra group membership <code>tere-socket-auth</code>.
It has a long-living connection to <code>tere-auth</code>.</p>
<p><code>tere-server</code> also handles WebSocket connections.
It processes the first few initial messages that authenticate the user, and after authentication copies data between WebSocket messages and <code>tere-user@</code><sup class="footnote-reference"><a href="#websocket-fd-pass">1</a></sup> (without parsing).
This is to keep unauthenticated actions lightweight, to avoid easy denial of service attacks.</p>
<p>Authentication happens inside the WebSocket connection and is tied to the WebSocket connection lifetime, to avoid the need for session tokens that could be stolen.</p>
<p>All decision-making regarding authentication is delegated to <code>tere-auth</code>.</p>
<div class="footnote-definition" id="websocket-fd-pass"><sup class="footnote-definition-label">1</sup>
<p>In the separate TLS termination, non-HTTP/2 case, <code>tere-server</code> could use FD passing to completely transfer the WebSocket-speaking network socket to <code>tere-user@</code>.
With TLS or WebSockets-over-HTTP/2, it will have to stay in the data path, wrapping and unwrapping the stream in these transports.
We'd rather aim for the future, so we're doing that.</p>
</div>
<h3 id="tere-auth-authenticates-users"><a class="header" href="#tere-auth-authenticates-users"><code>tere-auth</code> authenticates users</a></h3>
<p><code>tere-auth</code> makes WebAuthn authentication decisions.
It holds extra group memberships <code>tere-socket-user</code> and <code>tere-socket-policy</code>.</p>
<p>After successful authentication, it connects to the <code>tere-policy@</code> service, which makes systemd spawn a new process.
It also connects to the <code>tere-user@</code> service, and after a handshake passes the just established policy connection to the new <code>tere-user@</code> instance.<sup class="footnote-reference"><a href="#why-auth-to-policy">2</a></sup>
This indirection removes <code>tere-auth</code> from the data path for an authenticated connection.</p>
<div class="footnote-definition" id="why-auth-to-policy"><sup class="footnote-definition-label">2</sup>
<p>Why connect to <code>tere-policy@</code> from <code>tere-auth</code>, not from <code>tere-user@</code> where that connection is actually used?
So that <code>tere-user@</code>, which deals with more complex hostile input, can't make <em>other</em> connections and claim to be other usernames.</p>
</div>
<h3 id="tere-user-speaks-with-with-clients"><a class="header" href="#tere-user-speaks-with-with-clients"><code>tere-user@</code> speaks with with clients</a></h3>
<p><code>tere-user@</code> parses most complex potentially hostile input, it is named so because it is the user representative on the server host, and most likely to come under complete user control.
Each authenticated WebSocket connection gets a dedicated <code>tere-user@</code> worker.</p>
<p>It speaks a length-prefixed message protocol.
WebSocket frames from browser clients will be translated to these messages by <code>tere-server</code>, and once a command-line client exists, it'll probably bypass the WebSocket protocol and speak this protocol directly.</p>
<p>It transports shell session requests, shell session input/output streams, and such between the client and the <code>tere-policy@</code> worker, and via further FD passing to <code>tere-sessions</code> and further to <code>tere-pty@</code>.</p>
<h3 id="tere-policy-makes-authorization-decisions"><a class="header" href="#tere-policy-makes-authorization-decisions"><code>tere-policy@</code> makes authorization decisions</a></h3>
<p><code>tere-policy@</code> makes authorization decisions based on its configuration.
It holds an extra group membership <code>tere-socket-sessions</code>.
Each authenticated WebSocket connection gets a dedicated <code>tere-user@</code> worker.</p>
<p>It reads a message from the connection stating the username, and binds the connection to that username in its state, before parsing any user input.</p>
<p>It processes authenticated end user requests such as &quot;create a new shell sessions&quot;, running them through a policy engine, and when allowed relays them to the <code>tere-sessions</code> service, relaying data and passed FDs back to the client.</p>
<h3 id="tere-sessions-starts-and-manages-shell-sessions"><a class="header" href="#tere-sessions-starts-and-manages-shell-sessions"><code>tere-sessions</code> starts and manages shell sessions</a></h3>
<p><code>tere-sessions</code> uses D-Bus to talk to <a href="https://www.freedesktop.org/software/systemd/man/systemd-machined.service.html"><code>systemd-machined</code></a> to create shell sessions.
It holds an extra group memberships <code>tere-dbus</code> (that allows the above) and <code>tere-socket-sessions</code>.</p>
<p>For every created shell session, <code>systemd-machined</code> returns a PTY FD.
<code>tere-sessions</code> connects to <code>tere-pty@</code>, which makes systemd spawn a new process, and hands the PTY FD to that new process.
It remembers that connection, identified by a random unique session ID.
<code>tere-sessions</code> <a href="https://www.freedesktop.org/software/systemd/man/sd_notify.html#FDSTORE=1">stores both of these FDs in systemd</a> for restarts.<sup class="footnote-reference"><a href="#store-both-fds">3</a></sup>
Later requests to open an existing connection are served by messaging the right <code>tere-pty@</code> process.</p>
<p>For connecting to already existing shell sessions, <code>tere-sessions</code> proxies the request to the <code>tere-pty@</code> instance for that session.</p>
<p><code>tere-sessions</code> exists as separate from <code>tere-pty@</code> for two reasons: to prevent D-Bus access after a sandbox escape, and to have a place that can store and re-serve PTY FDs after a software restart or crash.</p>
<div class="footnote-definition" id="store-both-fds"><sup class="footnote-definition-label">3</sup>
<p>Both the PTY FD and the connection to <code>tere-pty@</code> are stored so <code>tere-sessions</code> can avoid starting a new <code>tere-pty@</code> instance when a previous one is already serving that PTY FD.
To handle crash recovery correctly, the communication must not lose track of message boundaries; we can use <a href="https://man7.org/linux/man-pages/man2/socket.2.html"><code>SOCK_SEQPACKET</code></a> for that.
The alternative would be to kill all <code>tere-pty@</code> processes on <code>tere-sessions</code> exit, e.g. via <a href="https://www.freedesktop.org/software/systemd/man/systemd.unit.html#BindsTo=">BindsTo=</a> or <a href="https://www.freedesktop.org/software/systemd/man/systemd.unit.html#PartOf=">PartOf=</a>.</p>
</div>
<h3 id="tere-pty-transports-data-to-and-from-a-pty"><a class="header" href="#tere-pty-transports-data-to-and-from-a-pty"><code>tere-pty@</code> transports data to and from a PTY</a></h3>
<p><code>tere-pty@</code> receives the PTY FD over the incoming connection, and later receives client requests.
Each shell session a dedicated <code>tere-pty@</code> worker.
Note that shell sessions and active users do not necessarily map 1:1.</p>
<p><code>tere-pty@</code> serves clients connecting to its sessions by creating a socketpair, used for PTY input/output and commands, and passing this FD to the client.
This indirection removes <code>tere-sessions</code> from the bulk data path.
Commands include updating the terminal size on window resize.</p>
<p>It transports data between the PTY and (once implemented) multiple clients, broadcasting the same PTY output stream to all clients.</p>
<h2 id="resources"><a class="header" href="#resources">Resources</a></h2>
<ul>
<li>https://landlock.io/ and https://crates.io/crates/landlock</li>
<li>https://github.com/openssh/openssh-portable/blob/master/README.privsep</li>
<li>http://www.citi.umich.edu/u/provos/ssh/privsep.html
(<a href="https://web.archive.org/web/20210424044821/http://www.citi.umich.edu/u/provos/ssh/privsep.html">archived</a>)</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../dev/sketch/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../dev/sketch/protocols.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../dev/sketch/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../dev/sketch/protocols.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../doc/mermaid.min.js"></script>
        
        <script type="text/javascript" src="../../doc/mermaid-init.js"></script>
        

        

    </body>
</html>
